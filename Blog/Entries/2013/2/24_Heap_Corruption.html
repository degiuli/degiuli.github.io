<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <meta name="Generator" content="iWeb 2.0.4" />
    <meta name="iWeb-Build" content="local-build-20130324" />
    <meta name="viewport" content="width=700" />
    <title>Windows Debugging Series</title>
    <link rel="stylesheet" type="text/css" media="screen,print" href="24_Heap_Corruption_files/24_Heap_Corruption.css" />
    <!--[if IE]><link rel='stylesheet' type='text/css' media='screen,print' href='24_Heap_Corruption_files/24_Heap_CorruptionIE.css'/><![endif]-->
    <script language="javascript" type="text/javascript"><!--

iWebBlogMainPageName = 'Blog.html';
iWebBlogMainPageTitle = 'Blog';
iWebBlogArchivePageName = 'Archive.html';
iWebBlogArchivePageTitle = 'Archive';
iWebBlogFeedType = 'static';


--></script>
    <script type="text/javascript" src="../../../../Scripts/iWebSite.js"></script>
    <script type="text/javascript" src="../../../../Scripts/Widgets/SharedResources/WidgetCommon.js"></script>
    <script type="text/javascript" src="../../../../Scripts/Widgets/Navbar/navbar.js"></script>
    <script type="text/javascript" src="http://www.me.com/1/up/comments/scripts/search.js"></script>
    <script type="text/javascript" src="../../../../Scripts/iWebBlog.js"></script>
    <script type="text/javascript" src="24_Heap_Corruption_files/24_Heap_Corruption.js"></script>
  </head>
  <body style="background: #ffffff url(24_Heap_Corruption_files/PhotoGray_browser_bg-3.jpg) repeat scroll top left; margin: 0pt; " onload="onPageLoad();" onunload="onPageUnload();">
    <div style="text-align: center; ">
      <div style="margin-bottom: 0px; margin-left: auto; margin-right: auto; margin-top: 0px; overflow: hidden; position: relative; word-wrap: break-word;  text-align: left; width: 700px; " id="body_content">
        <div style="background: transparent url(24_Heap_Corruption_files/PhotoGray_bg_c-1.jpg) repeat scroll top left; width: 700px; ">
          <div style="margin-left: 0px; position: relative; width: 700px; z-index: 0; " id="nav_layer">
            <div style="height: 0px; line-height: 0px; " class="bumper"> </div>
            <div style="height: 700px; width: 700px;  height: 700px; left: 0px; position: absolute; top: -80px; width: 700px; z-index: 1; " class="tinyText style_SkipStroke">
              <img src="24_Heap_Corruption_files/Darkroom_spotlight.jpg" alt="" style="border: none; height: 700px; width: 700px; " />
            </div>
            <div style="height: 1px; line-height: 1px; " class="tinyText"> </div>
            <div class="com-apple-iweb-widget-navbar flowDefining" id="widget0" style="margin-left: 0px; margin-top: 19px; position: relative; width: 700px; z-index: 1; ">
    
              <div id="widget0-navbar" class="navbar">

      
                <div id="widget0-bg" class="navbar-bg">

        
                  <ul id="widget0-navbar-list" class="navbar-list">
 <li></li> 
</ul>
                  
      
</div>
                
    
</div>
            </div>
            <script type="text/javascript"><!--//--><![CDATA[//><!--
new NavBar('widget0', '../../../../Scripts/Widgets/Navbar', '../../../../Scripts/Widgets/SharedResources', '../../../..', {"path-to-root": "..\/..\/..\/..\/", "navbar-css": ".navbar {\n\tfont-family: Futura, 'Trebuchet MS', sans-serif;\n\ttext-transform: uppercase;\n\tfont-size: .7em;\n\tcolor: #C1C1C1;\n\tline-height: 25px;\n\ttext-align: center;\n\tpadding: 0px;\n\tbackground-image: url(24_Heap_Corruption_files\/PhotoGray_nav_bg.png);\n\t_background-image: url(24_Heap_Corruption_files\/PhotoGray_nav_bg.jpg);\n\tbackground-repeat: repeat-y;\n\tborder-top: 1px solid #999;\n\tborder-bottom: 1px solid #999;\n}\n\n.navbar-bg {\n\tpadding: 6px 0px 4px 0px;\n}\n\n.navbar ul {\n\tlist-style: none;\n\tmargin: 0px;\n\tpadding: 0px 10px 0px 10px;\n}\n\n.navbar ul li {\n\tdisplay: inline; \n\tlist-style-type: none;\n\tmargin: 0px;\n\tpadding: 0px 10px 0px 10px;\n}\n\n\n.noncurrent-page  a:visited {\n\ttext-decoration: none;\n\tcolor: #C1C1C1;\n\ttext-shadow: 0px -1px 2px #333;\n}\n\n.noncurrent-page  a {\n\ttext-decoration: none;\n\tcolor: #C1C1C1;\n\ttext-shadow: 0px -1px 2px #333;\n}\n\n\n.noncurrent-page a:hover {\n\ttext-decoration: none;\n\tcolor: #EC001E;\n\ttext-shadow: 0px -1px 2px #333;\n}\n\n.current-page a\n{\n\ttext-decoration: none;\n\tcolor: #000;\n\ttext-shadow: 0px -1px 2px #7E7E7E;\n}\n\n.current-page a:visited\n{\n\ttext-decoration: none;\n\tcolor: #000;\n\ttext-shadow: 0px -1px 2px #7E7E7E;\n}\n\n", "current-page-GUID": "7F47D4D9-3681-40D5-944E-2CABD511A660", "isCollectionPage": "YES"});
//--><!]]></script>
            <div style="clear: both; height: 0px; line-height: 0px; " class="spacer"> </div>
          </div>
          <div style="height: 52px; margin-left: 0px; position: relative; width: 700px; z-index: 10; " id="header_layer">
            <div style="height: 0px; line-height: 0px; " class="bumper"> </div>
            <div id="id1" style="visibility: hidden;  height: 39px; left: 30px; position: absolute; top: 13px; width: 640px; z-index: 1; " class="style_SkipStroke_1">
              <div class="text-content Normal_External_640_39" style="padding: 0px; ">
                <div class="Normal">
                  <p style="padding-bottom: 0pt; padding-top: 0pt; " class="Header"><a title="../1/6_Introduction.html" href="../1/6_Introduction.html">Windows Debugging Series</a></p>
                </div>
              </div>
              <div id="generic-header-attribute" class="Header"></div>
            </div>
          </div>
          <div style="margin-left: 0px; position: relative; width: 700px; z-index: 5; " id="body_layer">
            <div style="height: 0px; line-height: 0px; " class="bumper"> </div>
            <div id="id2" style="visibility: hidden;  height: 29px; left: 30px; position: absolute; top: 44px; width: 640px; z-index: 1; " class="style_SkipStroke_2">
              <div class="text-content Normal_External_640_29" style="padding: 0px; ">
                <div class="Normal">
                  <p style="padding-bottom: 0pt; padding-top: 0pt; " class="Title">Heap Corruption</p>
                </div>
              </div>
              <div id="generic-title-attributes" class="Title"></div>
            </div>
            


            <div id="id3" style="visibility: hidden;  height: 23px; left: 30px; position: absolute; top: 14px; width: 640px; z-index: 1; " class="style_SkipStroke_3">
              <div class="text-content Normal_External_640_23" style="padding: 0px; ">
                <div class="Normal">
                  <p style="padding-bottom: 0pt; padding-top: 0pt; " class="Date">24 de fevereiro de 2013</p>
                </div>
              </div>
              <div id="generic-datefield-attributes" class="Date"></div>
            </div>
            <div style="height: 1px; line-height: 1px; " class="tinyText"> </div>
            <div style="visibility: hidden;  margin-left: 30px; margin-top: 84px; position: relative; width: 640px; z-index: 1; " class="style_SkipStroke_4 flowDefining">
              <div class="text-content Normal_External_640_3329" style="padding: 0px; ">
                <div class="Normal">
                  <p style="padding-top: 0pt; " class="paragraph_style"><span style="line-height: 22px; " class="style">What is Heap?</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">When an application dynamically allocates memory, it can rely on different methods, such as C-runtime heap (using the <span class="style_1">new</span>/<span class="style_1">delete</span> and <span class="style_2">malloc</span>/<span class="style_2">calloc</span>/<span class="style_2">realloc</span>/<span class="style_2">free</span> APIs), the default process heap, or yet application specific heaps (both use heap APIs). Eventually, all reaches the Heap Manager (NTDLL) and then Virtual Memory Manager.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">Heap is one form of Windows memory manager, which applications use to allocate and deallocate memory dynamically. Windows Heap has a complex architecture that will not be discussed in much details here. Instead, let’s sum up what happens when allocation and freeing a block of memory:<br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body"><span class="style_3">Allocating a block of memory:</span><br /></p>
                  <p class="Body">The Heap manager first consults the front end allocator to see if a free block of memory is available; if it is the heap manager returns it to the caller. Otherwise, the back end allocator’s free lists are consulted and:<br /></p>
                  <ol>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>If an exact size match is found, flags are updated to indicate that block is busy; the block is then removed from the free list and returned to the caller.<br /></p>
                    </li>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>If an exact size match cannot be found, the heap manager checks to see if a larger block can be split into two smaller blocks that satisfy the request allocation size. If it can, the block is split. One block has the flags updated to a busy state and is returned to the caller. The other block has its flags set to a free state and is added to the free list. The original block is also removed from the free list.<br /></p>
                    </li>
                  </ol>
                  <p class="Body">If the free lists cannot satisfy the allocation request, the heap manager commits more memory from the heap segment, creates a new bloc in the committed range (flags are set to busy state), and returns the block to the caller.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style_2">Freeing a block or memory:<br /></p>
                  <p class="Body">The front end allocator is consulted to see if it can handle the free block. If the free block is not handled by the front end allocator, heap manager checks if there are any adjacent free block; if so, it coalesces the blocks into one large block by doing the following:<br /></p>
                  <ol>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>The adjacent free blocks are removed from the free lists.<br /></p>
                    </li>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>The new large block is added to the free list or front end allocator.<br /></p>
                    </li>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>The flags flags field for the new large block is updated to indicate it is free.<br /></p>
                    </li>
                  </ol>
                  <p class="Body">If no coalescing can be performed, the block is moved into the free list or front end allocator and the flags are updated to a free state.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body"><span class="style_3">Some heap info:</span><br /></p>
                  <ol>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>Front end allocator has two policies on how memory blocks are handle. The first is look aside list (LAL), which is a table of 128 singly linked list. Each singly linked list in the table contains free heap blocks of a specific size starting at 16 bytes plus 8 bytes of metadata used to manage the block. Then, 32 bytes, then 48 bytes, and so on until 1024 bytes, in the last index. The second policy is low fragmentation (LF), which reduces the fragmentation described in LAL. LAL is default in Windows XP and Windows 2003, but the LF is also supported. Windows Vista and later has LF as default. <br /></p>
                    </li>
                    <li style="line-height: 21px; padding-left: 13px; text-indent: -13px; " class="full-width">
                      <p style="text-indent: -13px; " class="paragraph_style_1"><span style="font-size: 14px; " class="Bullet">*</span><span style="width: 4px; " class="inline-block"></span>Back end allocator contains a table of lists commonly referred to as the free list. The free list’s responsibility is to keep track of all the free heap blocks of a specific size.<br /></p>
                    </li>
                  </ol>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Accessing Uninitialized Memory</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">Accessing uninitialized memory is a common problem in software. Essentially, uninitialized memory refers to a block of memory, for instance a stack variable, that has been successfully allocated but not initialized to a state which is considered valid.<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> main(</span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> argc,</span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> argv[])<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">{<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_6">//allocate stack variable</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    size_t size;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        <br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_6">//dynamically allocate a memory</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_6">//using the uninitialized size</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> pdata = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[size];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        std::cout &lt;&lt; </span><span style="line-height: 13px; " class="style_7">&quot;Data: :&quot;</span><span style="line-height: 13px; " class="style_5">&lt;&lt; pdata &lt;&lt; </span><span style="line-height: 13px; " class="style_7">&quot;, Size: &quot;</span><span style="line-height: 13px; " class="style_5"> &lt;&lt; size &lt;&lt; std::endl;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//do something...</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] pdata;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_8">    </span><span style="line-height: 13px; " class="style_4">return</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_9">0</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">}<br /></span></p>
                  <p class="Body">The sample above show two possible problems related to uninitialized memory: (1) when the system allocates the <span class="style_2">size</span> variable, its memory may contain a value large enough the end up the system memory when <span class="style_2">pdata</span> is allocated, because the <span class="style_2">size</span> value is unknown; (2) independently on the value of size, when the <span class="style_2">std::cout</span> is performed, it is highly likely that it access invalid memory because it will not find the null character in the <span class="style_2">pdata</span> memory, probably crashing the application. When the system allocates memory to <span class="style_2">pdata</span>, a pattern is used to fill that new memory and it does not contains a null character.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Heap Overruns and Underruns</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">Each heap block, as stated earlier, has a metadata, that is used by the heap manager to properly handle that block. If a faulty piece of code overwrites that data, the heap integrity is compromised and the application will crash. This usually occurs when the block size is not respected and data is written beyond the block boundaries - overruns - or before its initial position - underruns.<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> main(</span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> argc,</span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> argv[])<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">{<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> pdata = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[</span><span style="line-height: 13px; " class="style_9">100</span><span style="line-height: 13px; " class="style_5">];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//overrun</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        memset(pdata,</span><span style="line-height: 13px; " class="style_9">0x00</span><span style="line-height: 13px; " class="style_5">,</span><span style="line-height: 13px; " class="style_9">110</span><span style="line-height: 13px; " class="style_5">);<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//underrun</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        memset(&amp;pdata[-</span><span style="line-height: 13px; " class="style_9">10</span><span style="line-height: 13px; " class="style_5">],</span><span style="line-height: 13px; " class="style_9">0x00</span><span style="line-height: 13px; " class="style_5">,</span><span style="line-height: 13px; " class="style_9">100</span><span style="line-height: 13px; " class="style_5">);<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_8">    </span><span style="line-height: 13px; " class="style_4">return</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_9">0</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">}<br /></span></p>
                  <p class="Body">Obviously, there is no reason to right such awful code. Let’s see a more realistic sample below, in which the input is saved into a internal memory and something (we don’t care) is done:<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> main(</span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> argc,</span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> argv[])<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">{<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> pdata = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[</span><span style="line-height: 13px; " class="style_9">10</span><span style="line-height: 13px; " class="style_5">];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata &amp;&amp; argc&gt;</span><span style="line-height: 13px; " class="style_9">1</span><span style="line-height: 13px; " class="style_5">)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        strcpy(pdata,argv[</span><span style="line-height: 13px; " class="style_9">1</span><span style="line-height: 13px; " class="style_5">]);<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//do something...</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] pdata;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_8">    </span><span style="line-height: 13px; " class="style_4">return</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_9">0</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">}<br /></span></p>
                  <p class="Body">In case the first application argument has more than 10 characters, it will certainly modify memory out of its boundaries. This could certainly corrupt the heap and crash the application.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">In addition to the crash and/or heap corruption this could also lead to other consequence that is a security hole. Similarly to the stack overrun, a hacker can also inject a piece of code to gain access to the system by using this technic.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Accessing Freed Memory</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">This is also a very common source of heap corruption. After being freed, a block is placed in the free list or front end allocation by the heap manager. From that point, it is considered invalid for application use. If the application uses it in any way, the free list will be corrupted and the application will crash.<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> main(</span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> argc,</span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> argv[])<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">{<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> pdata = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[</span><span style="line-height: 13px; " class="style_9">10</span><span style="line-height: 13px; " class="style_5">];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//do something...</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] pdata;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        <br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//do something more...</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(argc&gt;</span><span style="line-height: 13px; " class="style_9">1</span><span style="line-height: 13px; " class="style_5">)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">            strcpy(pdata,argv[</span><span style="line-height: 13px; " class="style_9">1</span><span style="line-height: 13px; " class="style_5">]);<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        std::cout &lt;&lt; pdata &lt;&lt; std::endl;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_8">    </span><span style="line-height: 13px; " class="style_4">return</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_9">0</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">}<br /></span></p>
                  <p class="Body">Whether or not there is an application argument, when the <span class="style_2">pdata</span> is access, the application is access invalid data. In both case, the application is reusing/accessing a freed memory and corrupting the heap.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Double Frees</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">An application frees some structure that it had already freed. In such a case, a subsequent reference can pick up a meaningless pointer, causing a heap segmentation violation. Possibly, the application will not crash but this can leads to unpredictable behavior.<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> main(</span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> argc, </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> argv[])<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">{<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> pdata = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[</span><span style="line-height: 13px; " class="style_9">10</span><span style="line-height: 13px; " class="style_5">];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">if</span><span style="line-height: 13px; " class="style_5">(pdata)<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    {<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_6">//do something...</span><span style="line-height: 13px; " class="style_5"><br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">        </span><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] pdata;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    }<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] pdata;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    </span><span style="line-height: 13px; " class="style_4">return</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_9">0</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">}</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Erroneous Free</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">An application calls an unappropriated memory release method to an addresses. For instance, the application allocates a memory array using <span class="style_1">new</span><span class="style_2">[]</span> but releases it using <span class="style_1">delete</span> or allocates a memory using <span class="style_2">malloc</span> and releases it using <span class="style_1">delete</span>.<br /></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5"> * int_new = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">int</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> [] int_new;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    <br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5"> * char_array = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">char</span><span style="line-height: 13px; " class="style_5">[</span><span style="line-height: 13px; " class="style_9">10</span><span style="line-height: 13px; " class="style_5">];<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> char_array;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    <br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">long</span><span style="line-height: 13px; " class="style_5"> * long_malloc = (</span><span style="line-height: 13px; " class="style_4">long</span><span style="line-height: 13px; " class="style_5">*)malloc(</span><span style="line-height: 13px; " class="style_4">sizeof</span><span style="line-height: 13px; " class="style_5">(</span><span style="line-height: 13px; " class="style_4">long</span><span style="line-height: 13px; " class="style_5">));<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">delete</span><span style="line-height: 13px; " class="style_5"> long_malloc;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">    <br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_4">double</span><span style="line-height: 13px; " class="style_5"> *double_new = </span><span style="line-height: 13px; " class="style_4">new</span><span style="line-height: 13px; " class="style_5"> </span><span style="line-height: 13px; " class="style_4">double</span><span style="line-height: 13px; " class="style_5">;<br /></span></p>
                  <p class="paragraph_style_3"><span style="line-height: 13px; " class="style_5">free(double_new);</span><br /></p>
                  <p class="Body">This kind of issue may not lead to a application crash but certainly leads to unpredictable behavior.<br /></p>
                  <p class="Body"><br /></p>
                  <p class="paragraph_style"><span style="line-height: 22px; " class="style">Heap Handle Mismatch</span><br /></p>
                  <p class="Body"><br /></p>
                  <p class="Body">Heap Manager keeps a list of active heaps in a process and an application can have heap handles in addition to the default one. Applications that directly accesses the Heap APIs should be take a extra care while deal with the default - taken from <span class="style_2">GetProcessHeap</span> API - and possibly internal process heap - created using <span class="style_2">HeapCreate</span> API.<br /></p>
                  <p class="Body"><br /></p>
                  <p style="padding-bottom: 0pt; " class="Body">Allocating memory using in one heap and freeing it using other may not cause visible issue at the moment, but one the mismatch occurs the heap gets corruption which later causes unpredictable behavior and access violation.</p>
                </div>
              </div>
              <div id="generic-body-attributes" class="Body"></div>
            </div>
            <div style="height: 0px; line-height: 0px; " class="spacer"> </div>
          </div>
          <div style="height: 150px; margin-left: 0px; position: relative; width: 700px; z-index: 15; " id="footer_layer">
            <div style="height: 0px; line-height: 0px; " class="bumper"> </div>
            <div id="id4" style="height: 30px; left: 350px; position: absolute; top: 20px; width: 319px; z-index: 1; " class="style_SkipStroke_5">
              <div class="text-content graphic_textbox_layout_style_default_External_319_30" style="padding: 0px; ">
                <div class="graphic_textbox_layout_style_default">
                  <div class="paragraph Next" style="padding-bottom: 0pt; padding-top: 0pt; "><a title="../3/10_WinDbg_Part_II.html" href="../3/10_WinDbg_Part_II.html" class="style_10">next</a><span class="style_11"> </span><div class="tinyText inline-block" style="height: 15px; position: relative; top: -3px; width: 10px; "><img usemap="#map1" id="shapeimage_1" src="24_Heap_Corruption_files/shapeimage_1.png" style="border: none; height: 21px; left: -3px; position: absolute; top: -3px; width: 16px; z-index: 1; " alt="" title="" /><map name="map1" id="map1"><area href="../3/10_WinDbg_Part_II.html" title="../3/10_WinDbg_Part_II.html" alt="../3/10_WinDbg_Part_II.html" coords="3, 3, 13, 18" /></map></div></div>
                </div>
                <div style="clear: both; height: 0px; line-height: 0px; " class="tinyText"> </div>
              </div>
            </div>
            


            <div id="id5" style="height: 30px; left: 30px; position: absolute; top: 20px; width: 320px; z-index: 1; " class="style_SkipStroke_5">
              <div class="text-content graphic_textbox_layout_style_default_External_320_30" style="padding: 0px; ">
                <div class="graphic_textbox_layout_style_default">
                  <div class="paragraph Previous" style="padding-bottom: 0pt; padding-top: 0pt; "><div class="tinyText inline-block" style="height: 15px; position: relative; width: 10px; "><img usemap="#map2" id="shapeimage_2" src="24_Heap_Corruption_files/shapeimage_2.png" style="border: none; height: 21px; left: -3px; position: absolute; top: -3px; width: 16px; z-index: 1; " alt="" title="" /><map name="map2" id="map2"><area href="24_Stack_Corruption.html" title="24_Stack_Corruption.html" alt="24_Stack_Corruption.html" coords="3, 3, 13, 18" /></map></div><span class="style_11"> </span><a title="24_Stack_Corruption.html" href="24_Stack_Corruption.html" class="style_11">previous</a></div>
                </div>
                <div style="clear: both; height: 0px; line-height: 0px; " class="tinyText"> </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>


